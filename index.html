<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>伪2.5D小区展示 - Pixi.js</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        width: 100%;
        height: 100vh;
        overflow: hidden;
        background: #333;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #gameContainer {
        width: 812px;
        height: 375px;
        position: relative;
        overflow: hidden;
        background: url(assets/img_05.png) center/100% 100% no-repeat;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        touch-action: none;
      }

      #gameCanvas {
        width: 812px;
        height: 375px;
        display: block;
      }

      .info-panel {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        max-width: 140px;
      }

      .info-panel h2 {
        margin: 0 0 6px 0;
        font-size: 12px;
        color: #333;
      }

      .info-panel p {
        margin: 3px 0;
        font-size: 10px;
        color: #666;
        line-height: 1.3;
      }

      .building-types {
        position: absolute;
        bottom: 8px;
        left: 8px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .building-types h3 {
        margin: 0 0 6px 0;
        font-size: 10px;
        color: #333;
      }

      .type-item {
        display: flex;
        align-items: center;
        margin: 3px 0;
        font-size: 9px;
      }

      .type-color {
        width: 12px;
        height: 12px;
        margin-right: 5px;
        border-radius: 2px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div id="gameContainer">
      <div id="gameCanvas"></div>

      <div class="info-panel" id="infoPanel">
        <h2>伪2.5D小区展示</h2>
        <p>点击楼栋查看详情</p>
        <p>滚轮缩放 | 拖拽移动</p>
      </div>

      <div class="building-types">
        <h3>楼栋类型</h3>
        <div class="type-item">
          <div class="type-color" style="background: #ff6b6b"></div>
          <span>住宅楼 (6层)</span>
        </div>
        <div class="type-item">
          <div class="type-color" style="background: #4ecdc4"></div>
          <span>高层住宅 (12层)</span>
        </div>
        <div class="type-item">
          <div class="type-color" style="background: #45b7d1"></div>
          <span>办公楼 (10层)</span>
        </div>
        <div class="type-item">
          <div class="type-color" style="background: #ffa07a"></div>
          <span>商业楼 (4层)</span>
        </div>
        <div class="type-item">
          <div class="type-color" style="background: #98d8c8"></div>
          <span>配套设施 (2层)</span>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    <script>
      // 楼栋类型配置 (移动端缩小版)
      const BUILDING_TYPES = {
        RESIDENTIAL_LOW: {
          name: "住宅楼",
          color: 0xff6b6b,
          width: 40,
          depth: 30,
          height: 45,
          floors: 6,
        },
        RESIDENTIAL_HIGH: {
          name: "高层住宅",
          color: 0x4ecdc4,
          width: 45,
          depth: 35,
          height: 75,
          floors: 12,
        },
        OFFICE: {
          name: "办公楼",
          color: 0x45b7d1,
          width: 50,
          depth: 40,
          height: 65,
          floors: 10,
        },
        COMMERCIAL: {
          name: "商业楼",
          color: 0xffa07a,
          width: 60,
          depth: 45,
          height: 30,
          floors: 4,
        },
        FACILITY: {
          name: "配套设施",
          color: 0x98d8c8,
          width: 30,
          depth: 25,
          height: 20,
          floors: 2,
        },
      };

      // 初始化Pixi应用 (固定尺寸)
      const app = new PIXI.Application({
        width: 812,
        height: 375,
        backgroundAlpha: 0,
        antialias: true,
      });
      document.getElementById("gameCanvas").appendChild(app.view);

      // 创建容器
      const worldContainer = new PIXI.Container();
      app.stage.addChild(worldContainer);

      // 等距投影转换函数
      function toIsometric(x, y, z = 0) {
        return {
          x: (x - y) * Math.cos(Math.PI / 6),
          y: (x + y) * Math.sin(Math.PI / 6) - z,
        };
      }

      // 创建楼栋类
      class Building {
        constructor(gridX, gridY, type, id) {
          this.gridX = gridX;
          this.gridY = gridY;
          this.type = type;
          this.id = id;
          this.container = new PIXI.Container();

          const config = BUILDING_TYPES[type];
          this.width = config.width;
          this.depth = config.depth;
          this.height = config.height;

          this.createBuilding(config);
          this.setupInteraction();
        }

        createBuilding(config) {
          const graphics = new PIXI.Graphics();

          // 等距投影的三个面
          const iso = toIsometric(0, 0, 0);

          // 顶面 (Top)
          graphics.beginFill(this.lightenColor(config.color, 0.3));
          const topPoints = [
            toIsometric(0, 0, this.height),
            toIsometric(this.width, 0, this.height),
            toIsometric(this.width, this.depth, this.height),
            toIsometric(0, this.depth, this.height),
          ];
          graphics.moveTo(topPoints[0].x, topPoints[0].y);
          topPoints.forEach((p) => graphics.lineTo(p.x, p.y));
          graphics.closePath();
          graphics.endFill();

          // 左面 (Left)
          graphics.beginFill(this.lightenColor(config.color, 0.1));
          const leftPoints = [
            toIsometric(0, 0, this.height),
            toIsometric(0, this.depth, this.height),
            toIsometric(0, this.depth, 0),
            toIsometric(0, 0, 0),
          ];
          graphics.moveTo(leftPoints[0].x, leftPoints[0].y);
          leftPoints.forEach((p) => graphics.lineTo(p.x, p.y));
          graphics.closePath();
          graphics.endFill();

          // 右面 (Right)
          graphics.beginFill(config.color);
          const rightPoints = [
            toIsometric(this.width, 0, this.height),
            toIsometric(this.width, 0, 0),
            toIsometric(this.width, this.depth, 0),
            toIsometric(this.width, this.depth, this.height),
          ];
          graphics.moveTo(rightPoints[0].x, rightPoints[0].y);
          rightPoints.forEach((p) => graphics.lineTo(p.x, p.y));
          graphics.closePath();
          graphics.endFill();

          // 边框
          graphics.lineStyle(2, 0x000000, 0.3);
          topPoints.forEach((p, i) => {
            if (i === 0) graphics.moveTo(p.x, p.y);
            else graphics.lineTo(p.x, p.y);
          });

          this.container.addChild(graphics);

          // 添加文字标签
          const text = new PIXI.Text(`${config.floors}F`, {
            fontSize: 8,
            fill: 0xffffff,
            fontWeight: "bold",
          });
          text.anchor.set(0.5);
          const topCenter = toIsometric(
            this.width / 2,
            this.depth / 2,
            this.height
          );
          text.x = topCenter.x;
          text.y = topCenter.y - 5;
          this.container.addChild(text);
        }

        lightenColor(color, amount) {
          const r = (color >> 16) & 0xff;
          const g = (color >> 8) & 0xff;
          const b = color & 0xff;

          return (
            (Math.min(255, r + r * amount) << 16) +
            (Math.min(255, g + g * amount) << 8) +
            Math.min(255, b + b * amount)
          );
        }

        setupInteraction() {
          this.container.eventMode = "static";
          this.container.cursor = "pointer";

          this.container.on("pointerover", () => {
            this.container.scale.set(1.05);
          });

          this.container.on("pointerout", () => {
            this.container.scale.set(1);
          });

          this.container.on("pointertap", () => {
            this.onClick();
          });
        }

        onClick() {
          const config = BUILDING_TYPES[this.type];
          const info = `
                    <h2>${config.name} #${this.id}</h2>
                    <p>楼层: ${config.floors}层</p>
                    <p>位置: (${this.gridX}, ${this.gridY})</p>
                    <p>高度: ${this.height}米</p>
                    <p>占地: ${this.width}x${this.depth}m²</p>
                `;
          document.getElementById("infoPanel").innerHTML = info;

          // 高亮效果
          this.container.scale.set(1.1);
          setTimeout(() => {
            this.container.scale.set(1);
          }, 200);
        }

        setPosition(x, y) {
          const iso = toIsometric(x, y, 0);
          this.container.x = iso.x;
          this.container.y = iso.y;
        }
      }

      // 生成楼栋布局
      let buildings = [];

      function generateBuildings() {
        // 清空现有楼栋
        buildings.forEach((b) => worldContainer.removeChild(b.container));
        buildings = [];

        const types = Object.keys(BUILDING_TYPES);
        const gridSize = 50;
        let buildingId = 1;

        // 紧凑布局 - 建筑紧贴
        const layout = [
          [0, 0],
          [2, 0],
          [4, 0],
          [6, 0],
          [8, 0],
          [10, 0],
          [0, 1],
          [2, 1],
          [4, 1],
          [6, 1],
          [8, 1],
          [10, 1],
          [0, 2],
          [2, 2],
          [4, 2],
          [6, 2],
          [8, 2],
          [10, 2],
          [0, 3],
          [2, 3],
          [4, 3],
          [6, 3],
          [8, 3],
          [10, 3],
          [0, 4],
          [2, 4],
          [4, 4],
          [6, 4],
          [8, 4],
          [10, 4],
          [0, 5],
          [2, 5],
          [4, 5],
          [6, 5],
          [8, 5],
          [10, 5],
        ];

        layout.forEach(([gx, gy]) => {
          const randomType = types[Math.floor(Math.random() * types.length)];
          const building = new Building(gx, gy, randomType, buildingId++);
          building.setPosition(gx * gridSize, gy * gridSize);
          buildings.push(building);
          worldContainer.addChild(building.container);
        });

        // 按Y坐标排序，实现正确的遮挡关系
        buildings.sort((a, b) => {
          const aY = a.gridX + a.gridY;
          const bY = b.gridX + b.gridY;
          return aY - bY;
        });

        buildings.forEach((b, index) => {
          worldContainer.setChildIndex(b.container, index);
        });
      }

      // 初始化相机位置 (适配移动端)
      worldContainer.x = 50;
      worldContainer.y = 30;
      worldContainer.scale.set(1);

      // 添加拖拽功能
      let isDragging = false;
      let dragStart = { x: 0, y: 0 };
      const container = document.getElementById("gameContainer");

      container.addEventListener("mousedown", (e) => {
        isDragging = true;
        dragStart = {
          x: e.clientX - worldContainer.x,
          y: e.clientY - worldContainer.y,
        };
      });

      container.addEventListener("mousemove", (e) => {
        if (isDragging) {
          worldContainer.x = e.clientX - dragStart.x;
          worldContainer.y = e.clientY - dragStart.y;
        }
      });

      container.addEventListener("mouseup", () => {
        isDragging = false;
      });

      // 添加缩放功能
      container.addEventListener("wheel", (e) => {
        e.preventDefault();
        const scaleFactor = e.deltaY > 0 ? 0.95 : 1.05;
        const newScale = worldContainer.scale.x * scaleFactor;

        if (newScale >= 0.3 && newScale <= 2) {
          worldContainer.scale.set(newScale);
        }
      });

      // 初始生成楼栋
      generateBuildings();
    </script>
  </body>
</html>
