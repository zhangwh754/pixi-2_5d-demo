<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>伪2.5D小区展示 - Pixi.js</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        width: 100%;
        height: 100vh;
        overflow: hidden;
        background: #333;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #gameContainer {
        width: 812px;
        height: 375px;
        position: relative;
        overflow: hidden;
        background: url(assets/img_05.png) center/100% 100% no-repeat;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        touch-action: none;
      }

      #gameCanvas {
        width: 812px;
        height: 375px;
        display: block;
      }

      .info-panel {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        max-width: 140px;
      }

      .info-panel h2 {
        margin: 0 0 6px 0;
        font-size: 12px;
        color: #333;
      }

      .info-panel p {
        margin: 3px 0;
        font-size: 10px;
        color: #666;
        line-height: 1.3;
      }

      .building-types {
        position: absolute;
        bottom: 8px;
        left: 8px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .building-types h3 {
        margin: 0 0 6px 0;
        font-size: 10px;
        color: #333;
      }

      .type-item {
        display: flex;
        align-items: center;
        margin: 3px 0;
        font-size: 9px;
      }

      .type-color {
        width: 12px;
        height: 12px;
        margin-right: 5px;
        border-radius: 2px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div id="gameContainer">
      <div id="gameCanvas"></div>

      <div class="info-panel" id="infoPanel">
        <h2>伪2.5D小区展示</h2>
        <p>点击楼栋查看详情</p>
        <p>滚轮缩放 | 拖拽移动</p>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    <script>
      // 楼栋类型配置
      const BUILDING_TYPES = {
        RESIDENTIAL_LOW: {
          name: "住宅楼",
          normalImage: "assets/img_06.png",
          activeImage: "assets/img_17.png",
          width: 92,
          height: 170,
          floors: 6,
        },
        RESIDENTIAL_HIGH: {
          name: "高层住宅",
          normalImage: "assets/img_08.png",
          activeImage: "assets/img_11.png",
          width: 123,
          height: 188,
          floors: 12,
        },
        OFFICE: {
          name: "办公楼",
          normalImage: "assets/img_09.png",
          activeImage: "assets/img_13.png",
          width: 132,
          height: 126,
          floors: 10,
        },
        COMMERCIAL: {
          name: "商业楼",
          normalImage: "assets/img_10.png",
          activeImage: "assets/img_15.png",
          width: 86,
          height: 194,
          floors: 4,
        },
      };

      // 图片资源缓存
      const imageCache = {};

      // 预加载图片资源
      function preloadImages() {
        const promises = [];
        Object.values(BUILDING_TYPES).forEach((config) => {
          // 加载正常态图片
          promises.push(
            new Promise((resolve) => {
              const img = new Image();
              img.onload = () => {
                imageCache[config.normalImage] = img;
                resolve();
              };
              img.onerror = () => {
                console.warn(`Failed to load: ${config.normalImage}`);
                resolve();
              };
              img.src = config.normalImage;
            })
          );
          // 加载激活态图片
          promises.push(
            new Promise((resolve) => {
              const img = new Image();
              img.onload = () => {
                imageCache[config.activeImage] = img;
                resolve();
              };
              img.onerror = () => {
                console.warn(`Failed to load: ${config.activeImage}`);
                resolve();
              };
              img.src = config.activeImage;
            })
          );
        });
        return Promise.all(promises);
      }

      // 初始化Pixi应用 (固定尺寸)
      const app = new PIXI.Application({
        width: 812,
        height: 375,
        backgroundAlpha: 0,
        antialias: true,
      });
      document.getElementById("gameCanvas").appendChild(app.view);

      // 创建容器
      const worldContainer = new PIXI.Container();
      app.stage.addChild(worldContainer);

      // 等距投影转换函数
      function toIsometric(x, y, z = 0) {
        return {
          x: (x - y) * Math.cos(Math.PI / 6),
          y: (x + y) * Math.sin(Math.PI / 6) - z,
        };
      }

      // 创建楼栋类
      class Building {
        constructor(gridX, gridY, type, id, isActive = false) {
          this.gridX = gridX;
          this.gridY = gridY;
          this.type = type;
          this.id = id;
          this.isActive = isActive;
          this.container = new PIXI.Container();

          const config = BUILDING_TYPES[type];
          this.width = config.width;
          this.height = config.height;

          this.createBuilding(config);
          this.setupInteraction();
        }

        createBuilding(config) {
          // 创建可点击区域边框（红色）
          const hitArea = new PIXI.Graphics();
          hitArea.lineStyle(2, 0xff0000, 0.8);
          hitArea.drawRect(
            -this.width / 2,
            -this.height,
            this.width,
            this.height
          );
          hitArea.hitArea = new PIXI.Rectangle(
            -this.width / 2,
            -this.height,
            this.width,
            this.height
          );
          this.container.addChild(hitArea);

          // 创建正常态精灵
          const normalTexture = PIXI.Texture.from(config.normalImage);
          this.normalSprite = new PIXI.Sprite(normalTexture);
          this.normalSprite.anchor.set(0.5, 1); // 底部中心为锚点
          this.normalSprite.visible = !this.isActive;
          this.container.addChild(this.normalSprite);

          // 创建激活态精灵
          const activeTexture = PIXI.Texture.from(config.activeImage);
          this.activeSprite = new PIXI.Sprite(activeTexture);
          this.activeSprite.anchor.set(0.5, 1); // 底部中心为锚点
          this.activeSprite.visible = this.isActive;
          this.container.addChild(this.activeSprite);

          // 添加文字标签
          const text = new PIXI.Text(`${config.floors}F`, {
            fontSize: 12,
            fill: 0xffffff,
            fontWeight: "bold",
            stroke: 0x000000,
            strokeThickness: 2,
          });
          text.anchor.set(0.5);
          text.y = -this.height + 20;
          this.container.addChild(text);
        }

        setActive(active) {
          if (this.isActive === active) return;
          this.isActive = active;
          this.normalSprite.visible = !active;
          this.activeSprite.visible = active;
        }

        setupInteraction() {
          this.container.eventMode = "static";
          this.container.cursor = "pointer";

          this.container.on("pointertap", () => {
            this.onClick();
          });
        }

        onClick() {
          const config = BUILDING_TYPES[this.type];
          const info = `
                    <h2>${config.name} #${this.id}</h2>
                    <p>楼层: ${config.floors}层</p>
                    <p>位置: (${this.gridX}, ${this.gridY})</p>
                    <p>高度: ${this.height}px</p>
                    <p>宽度: ${this.width}px</p>
                `;
          document.getElementById("infoPanel").innerHTML = info;

          // 更新激活状态
          buildings.forEach((b) => b.setActive(b.id === this.id));
        }

        setPosition(x, y) {
          const iso = toIsometric(x, y, 0);
          this.container.x = iso.x;
          this.container.y = iso.y;
        }
      }

      // 生成楼栋布局
      let buildings = [];

      function generateBuildings(activeId = null) {
        // 清空现有楼栋
        buildings.forEach((b) => worldContainer.removeChild(b.container));
        buildings = [];

        const types = Object.keys(BUILDING_TYPES);
        const gridSize = 50;
        let buildingId = 1;

        // 2x2 布局
        const layout = [
          [2, 1],
          [4, 1],
          [2, 3],
          [4, 3],
        ];

        // 依次使用四种类型
        const typeKeys = [
          "RESIDENTIAL_LOW",
          "RESIDENTIAL_HIGH",
          "OFFICE",
          "COMMERCIAL",
        ];

        layout.forEach(([gx, gy], index) => {
          const id = buildingId++;
          const isActive = activeId && id === activeId;
          const building = new Building(gx, gy, typeKeys[index], id, isActive);
          building.setPosition(gx * gridSize, gy * gridSize);
          buildings.push(building);
          worldContainer.addChild(building.container);
        });

        // 按Y坐标排序，实现正确的遮挡关系
        buildings.sort((a, b) => {
          const aY = a.gridX + a.gridY;
          const bY = b.gridX + b.gridY;
          return aY - bY;
        });

        buildings.forEach((b, index) => {
          worldContainer.setChildIndex(b.container, index);
        });
      }

      // 初始化相机位置 (居中显示)
      worldContainer.x = 406;
      worldContainer.y = 180;

      // 预加载图片后生成楼栋
      preloadImages().then(() => {
        generateBuildings();
      });
    </script>
  </body>
</html>
